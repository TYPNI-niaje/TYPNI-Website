<!DOCTYPE html>
<html lang="en">

<head>
    <!-- ========== Meta Tags ========== -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="typni website">

    <!-- ========== Page Title ========== -->
    <title> join - Typni</title>

    <!-- ========== Favicon Icon ========== -->
    <link rel="shortcut icon" href="assets/img/favicon.png" type="image/x-icon">

    <!-- ========== Start Stylesheet ========== -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/css/font-awesome.min.css" rel="stylesheet" />
    <link href="assets/css/flaticon-charity-set.css" rel="stylesheet" />
    <link href="assets/css/magnific-popup.css" rel="stylesheet" />
    <link href="assets/css/owl.carousel.min.css" rel="stylesheet" />
    <link href="assets/css/owl.theme.default.min.css" rel="stylesheet" />
    <link href="assets/css/animate.css" rel="stylesheet" />
    <link href="assets/css/bootsnav.css" rel="stylesheet" />
    <link href="style.css" rel="stylesheet">
    <link href="assets/css/responsive.css" rel="stylesheet" />
    <link href="assets/css/modern-preloader.css" rel="stylesheet" />
    <link href="assets/css/modern-enhancements.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css">
    <!-- ========== End Stylesheet ========== -->

    

    <!-- ========== Google Fonts ========== -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,600,700,900" rel="stylesheet">

    <script>
        // Global notification functions
        function dismissNotification() {
            const overlay = document.getElementById('modal-overlay');
            const modal = document.getElementById('modal-notification');
            
            if (!overlay || !modal) return;
            
            // Remove show classes
            overlay.classList.remove('show');
            modal.classList.remove('show');
            
            // Add fade out animation
            overlay.style.animation = 'fadeOut 0.3s ease-out';
            modal.style.animation = 'fadeOut 0.3s ease-out';
            
            // Wait for animation to complete before redirecting
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 300);
        }

        function showNotification() {
            const overlay = document.getElementById('modal-overlay');
            const modal = document.getElementById('modal-notification');
            
            if (!overlay || !modal) return;
            
            // Reset any previous animations
            overlay.style.animation = '';
            modal.style.animation = '';
            
            // Show the modal and overlay
            overlay.classList.add('show');
            modal.classList.add('show');
        }

        // Initialize event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Add fade out animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            // Add click handler for dismiss button
            const dismissBtn = document.getElementById('dismiss-notification-btn');
            if (dismissBtn) {
                dismissBtn.addEventListener('click', dismissNotification);
            }
        });
    </script>

</head>

<body>
    <!-- Scroll Progress Indicator -->
    <div class="scroll-indicator" id="scroll-progress"></div>


    <!-- Header 
    ============================================= -->
    <div id="header-placeholder"></div>
    <script>
    fetch('assets/components/header.html') // make sure this path is correct
        .then(response => response.text())
        .then(data => {
        document.getElementById('header-placeholder').innerHTML = data;
        });
    </script>
    <!-- End Header-->

    <!-- Start Breadcrumb 
    ============================================= -->
    <div class="breadcrumb-area shadow dark bg-fixed text-center padding-xl text-light" style="background-image: url(assets/img/hero1.jpg);">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-sm-6 text-left">
                    <h1>Member Registration</h1>
                </div>
                <div class="col-md-6 col-sm-6 text-right">
                    <ul class="breadcrumb">
                        <li><a href="#">Home</a></li>
                        <li><a href="#">Page</a></li>
                        <li class="active">Register</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- End Breadcrumb -->

    <!-- Start Membership registration 
    ============================================= -->
    <div style="top: -100 !important;" class="registration-form default-padding">
        <div class="container">
            <div class="row">
            <h2 style="color: white;"></h2>
                <div class="form">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Register</h3>
                        </div>
                        <div class="panel-body">
                            <form>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="name">Your Name</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="name" placeholder="Name as per ID" required>
                                                <span class="input-group-addon"><i class="fas fa-user"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="phone_number">Phone Number</label>
                                            <div class="input-group">
                                                <input type="tel" class="form-control" id="phone_number" required>
                                                <span class="input-group-addon"><i class="fas fa-phone"></i></span>
                                            </div>
                                            <small class="form-text text-muted">Please enter a valid phone number with country code.</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id-number">ID Number</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="idNumber" placeholder="Your Id Number" required>
                                                <span class="input-group-addon"><i class="fas fa-flag"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="email">Email </label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="email" placeholder="yourname@mail.com" required>
                                                <span class="input-group-addon"><i class="fas fa-envelope"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="date_of_birth">Date Of Birth</label>
                                            <div class="input-group">
                                                <input type="date" class="form-control" id="date_of_birth" required>
                                                <span class="input-group-addon"><i class="fas fa-birthday-cake"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="donateType">Gender</label>
                                            <select id="gender" class="form-control">
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                                <option value="not Say">Rather Not Say</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="country">Country</label>
                                            <select id="country" class="form-control countries-dropdown">
                                                <!-- Will be populated by JavaScript -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="employment">Are You Employed?</label>
                                            <select id="employment" class="form-control">
                                                <option value="false">No</option>
                                                <option value="true">Yes</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="email">Higest Level Of Education </label>
                                            <select id="education" class="form-control">
                                                <option value="highschool">High School</option>
                                                <option value="tvet">TVET</option>
                                                <option value="college">College</option>
                                                <option value="university">University</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="pwd_status">Person with Disability (PWD) Status</label>
                                            <select id="pwd_status" class="form-control">
                                                <option value="no">No</option>
                                                <option value="yes">Yes</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="organization">Organization (Optional)</label>
                                            <input type="text" class="form-control" id="organization" name="user_organization" placeholder="Enter organization name" autocomplete="off">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="interests">Select Your Top 3 Interests *</label>
                                        <div class="interests-container">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="youth-empowerment" name="interests" value="youth-empowerment">
                                                        <label for="youth-empowerment">Youth Empowerment</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="youth-mentorship" name="interests" value="youth-mentorship">
                                                        <label for="youth-mentorship">Youth Mentorship</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="youth-employment" name="interests" value="youth-employment">
                                                        <label for="youth-employment">Youth Employment</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="entrepreneurship" name="interests" value="entrepreneurship">
                                                        <label for="entrepreneurship">Entrepreneurship</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="financial-literacy" name="interests" value="financial-literacy">
                                                        <label for="financial-literacy">Financial Literacy</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="youth-representation" name="interests" value="youth-representation">
                                                        <label for="youth-representation">Youth Representation</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="education" name="interests" value="education">
                                                        <label for="education">Education</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="sports-arts-talent" name="interests" value="sports-arts-talent">
                                                        <label for="sports-arts-talent">Sports, Arts & Talent</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="pan-africanism" name="interests" value="pan-africanism">
                                                        <label for="pan-africanism">Pan Africanism</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="technology-digital-literacy" name="interests" value="technology-digital-literacy">
                                                        <label for="technology-digital-literacy">Technology & Digital Literacy</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="menstrual-health" name="interests" value="menstrual-health">
                                                        <label for="menstrual-health">Menstrual Health</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="sexual-education" name="interests" value="sexual-education">
                                                        <label for="sexual-education">Sexual Education</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="female-genital-mutilation" name="interests" value="female-genital-mutilation">
                                                        <label for="female-genital-mutilation">Female Genital Mutilation</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="childhood-marriages" name="interests" value="childhood-marriages">
                                                        <label for="childhood-marriages">Childhood Marriages</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="childhood-pregnancies" name="interests" value="childhood-pregnancies">
                                                        <label for="childhood-pregnancies">Childhood Pregnancies</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="alcohol-drugs-substance-abuse" name="interests" value="alcohol-drugs-substance-abuse">
                                                        <label for="alcohol-drugs-substance-abuse">Alcohol, Drugs & Substance Abuse</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="mental-health-action" name="interests" value="mental-health-action">
                                                        <label for="mental-health-action">Mental Health Action</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="inclusivity-young-pwds" name="interests" value="inclusivity-young-pwds">
                                                        <label for="inclusivity-young-pwds">Inclusivity of Young PWDs</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="cyberbullying" name="interests" value="cyberbullying">
                                                        <label for="cyberbullying">Cyberbullying</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="blood-donation" name="interests" value="blood-donation">
                                                        <label for="blood-donation">Blood Donation</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="climate-change-mitigation" name="interests" value="climate-change-mitigation">
                                                        <label for="climate-change-mitigation">Climate Change Mitigation</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="climate-change-adaptation-resilience" name="interests" value="climate-change-adaptation-resilience">
                                                        <label for="climate-change-adaptation-resilience">Climate Change Adaptation & Resilience</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="nature-based-solutions" name="interests" value="nature-based-solutions">
                                                        <label for="nature-based-solutions">Nature-Based Solutions</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="water-solutions-management" name="interests" value="water-solutions-management">
                                                        <label for="water-solutions-management">Water Solutions & Management</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="interest-option">
                                                        <input type="checkbox" id="smart-agriculture" name="interests" value="smart-agriculture">
                                                        <label for="smart-agriculture">Smart Agriculture</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">Please select up to 3 interests that best match your preferences.</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="email">PassWord </label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="password" placeholder="Password" required>
                                                <span class="input-group-addon"><i class="fas fa-lock"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="email">PassWord </label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="password" placeholder="Retype Password" required>
                                                <span class="input-group-addon"><i class="fas fa-lock"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>   
                                <div class="row">
                                    <div class="col-md-12">
                                        <button class="btn btn-theme effect btn-sm" type="submit">Register Now</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="modal-overlay" class="modal-overlay"></div>
    <div id="modal-notification" class="modal-notification">
        <div class="title">Registration Successful!</div>
        <div class="message">Please check your email to verify your account. You'll need to verify your email before you can log in.</div>
        <button type="button" class="dismiss-btn" id="dismiss-notification-btn">Got it</button>
    </div>
    
    <script>
        // Add click handler for dismiss button
        document.getElementById('dismiss-notification-btn').addEventListener('click', function() {
            const overlay = document.getElementById('modal-overlay');
            const modal = document.getElementById('modal-notification');
            
            // Remove show classes
            overlay.classList.remove('show');
            modal.classList.remove('show');
            
            // Add fade out animation
            overlay.style.animation = 'fadeOut 0.3s ease-out';
            modal.style.animation = 'fadeOut 0.3s ease-out';
            
            // Wait for animation to complete before redirecting
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 300);
        });
    </script>

    <!-- Start Footer 
    ============================================= -->
    <div id="footer-placeholder"></div>
    <script>
    fetch('assets/components/footer.html') // make sure this path is correct
        .then(response => response.text())
        .then(data => {
        document.getElementById('footer-placeholder').innerHTML = data;
        });
    </script>
    <!-- End Footer -->

    <!-- jQuery Frameworks
    ============================================= -->
    <script src="assets/js/jquery-1.12.4.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/equal-height.min.js"></script>
    <script src="assets/js/jquery.appear.js"></script>
    <script src="assets/js/jquery.easing.min.js"></script>
    <script src="assets/js/jquery.magnific-popup.min.js"></script>
    <script src="assets/js/progress-bar.min.js"></script>
    <script src="assets/js/modernizr.custom.13711.js"></script>
    <script src="assets/js/owl.carousel.min.js"></script>
    <script src="assets/js/wow.min.js"></script>
    <script src="assets/js/isotope.pkgd.min.js"></script>
    <script src="assets/js/imagesloaded.pkgd.min.js"></script>
    <script src="assets/js/count-to.js"></script>
    <script src="assets/js/bootsnav.js"></script>
    <script src="assets/js/YTPlayer.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/modern-preloader.js"></script>
    <script src="assets/js/modern-scroll-animations.js"></script>
    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    <script src="utils/globalAuth.js"></script>
    <script src="utils/authGuard.js" defer></script>
    <script type="module">
        import { signUp, supabase } from './utils/supabaseClient.js';
        
        // Make sure we have access to supabase
        if (!supabase) {
            console.error('Supabase client not initialized');
        }
        
    document.addEventListener('DOMContentLoaded', async function() {
        // Initialize phone input
        const phoneInput = window.intlTelInput(document.querySelector("#phone_number"), {
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
            preferredCountries: ["ke", "ug", "tz"], // Kenya, Uganda, Tanzania
            separateDialCode: true,
            initialCountry: "ke",
            placeholderNumberType: "MOBILE"
        });

        // Fetch interests from database to populate checkboxes with correct IDs
        const interestsContainer = document.querySelector('.interests-container .row');
        try {
            const { data: interests, error } = await supabase
                .from('interests')
                .select('id, name')
                .order('name');
            
            if (error) throw error;
            
            // Store interests data for form submission
            window.interestsData = interests.reduce((acc, interest) => {
                // Convert name to kebab-case for checkbox value
                const kebabName = interest.name.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, '-');
                acc[kebabName] = interest.id;
                return acc;
            }, {});

                // Create checkboxes for each interest
                interests.forEach(interest => {
                    const kebabName = interest.name.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, '-');
                    const div = document.createElement('div');
                    div.className = 'col-md-4 interest-option';
                    div.innerHTML = `
                        <input type="checkbox" id="${kebabName}" name="interests" value="${kebabName}">
                        <label for="${kebabName}">${interest.name}</label>
                    `;
                    interestsContainer.appendChild(div);
                });
        } catch (error) {
            console.error('Failed to fetch interests:', error);
                interestsContainer.innerHTML = '<div class="col-12"><p class="text-danger">Failed to load interests. Please try refreshing the page.</p></div>';
        }

        // Initialize countries dropdown
        const countrySelect = document.getElementById('country');
            const preferredCountries = ['KE', 'UG', 'TZ']; // Kenya, Uganda, Tanzania
            
            // Function to get country name and flag
            function getCountryOption(code) {
                const countryName = new Intl.DisplayNames(['en'], { type: 'region' }).of(code);
                return {
                    code: code,
                    name: countryName,
                    flag: code.toLowerCase()
                };
            }

            // Get all countries
            const allCountryCodes = ["AF","AL","DZ","AS","AD","AO","AI","AQ","AG","AR","AM","AW","AU","AT","AZ","BS","BH","BD","BB","BY","BE","BZ","BJ","BM","BT","BO","BA","BW","BV","BR","IO","BN","BG","BF","BI","KH","CM","CA","CV","KY","CF","TD","CL","CN","CX","CC","CO","KM","CG","CD","CK","CR","CI","HR","CU","CY","CZ","DK","DJ","DM","DO","EC","EG","SV","GQ","ER","EE","ET","FK","FO","FJ","FI","FR","GF","PF","TF","GA","GM","GE","DE","GH","GI","GR","GL","GD","GP","GU","GT","GN","GW","GY","HT","HM","VA","HN","HK","HU","IS","IN","ID","IR","IQ","IE","IL","IT","JM","JP","JO","KZ","KE","KI","KP","KR","KW","KG","LA","LV","LB","LS","LR","LY","LI","LT","LU","MO","MK","MG","MW","MY","MV","ML","MT","MH","MQ","MR","MU","YT","MX","FM","MD","MC","MN","MS","MA","MZ","MM","NA","NR","NP","NL","NC","NZ","NI","NE","NG","NU","NF","MP","NO","OM","PK","PW","PS","PA","PG","PY","PE","PH","PN","PL","PT","PR","QA","RE","RO","RU","RW","SH","KN","LC","PM","VC","WS","SM","ST","SA","SN","SC","SL","SG","SK","SI","SB","SO","ZA","GS","ES","LK","SD","SR","SJ","SZ","SE","CH","SY","TW","TJ","TZ","TH","TL","TG","TK","TO","TT","TN","TR","TM","TC","TV","UG","UA","AE","GB","US","UM","UY","UZ","VU","VE","VN","VG","VI","WF","EH","YE","ZM","ZW"];
            
            // Create preferred countries array with names and flags
            const preferredCountryOptions = preferredCountries.map(getCountryOption);
            
            // Create all countries array with names and flags
            const allCountryOptions = allCountryCodes.map(getCountryOption)
                .filter(country => !preferredCountries.includes(country.code))
                .sort((a, b) => a.name.localeCompare(b.name));

            // Clear existing options
            countrySelect.innerHTML = '';

            // Add preferred countries group
            if (preferredCountryOptions.length > 0) {
                const preferredGroup = document.createElement('optgroup');
                preferredGroup.label = 'Preferred Countries';
                preferredCountryOptions.forEach(country => {
            const option = document.createElement('option');
                    option.value = country.code;
                    option.innerHTML = `<span class="flag-icon flag-icon-${country.flag}"></span> ${country.name}`;
                    preferredGroup.appendChild(option);
                });
                countrySelect.appendChild(preferredGroup);

                // Add separator
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '──────────';
                countrySelect.appendChild(separator);
            }

            // Add all other countries
            const otherGroup = document.createElement('optgroup');
            otherGroup.label = 'All Countries';
            allCountryOptions.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.innerHTML = `<span class="flag-icon flag-icon-${country.flag}"></span> ${country.name}`;
                otherGroup.appendChild(option);
            });
            countrySelect.appendChild(otherGroup);

        const form = document.querySelector('form');
        const interestCheckboxes = document.querySelectorAll('input[name="interests"]');
        
        // Limit interests to 3 selections
        interestCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkedBoxes = document.querySelectorAll('input[name="interests"]:checked');
                if (checkedBoxes.length > 3) {
                    this.checked = false;
                    alert('You can only select up to 3 interests.');
                }
            });
        });
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Prevent multiple submissions
            if (form.dataset.submitting === 'true') return;
            form.dataset.submitting = 'true';
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;
            
            // Validate phone number
            if (!phoneInput.isValidNumber()) {
                alert('Please enter a valid phone number.');
                form.dataset.submitting = 'false';
                if (submitBtn) submitBtn.disabled = false;
                return;
            }

            // Get selected interest values
            const selectedInterestValues = Array.from(
                document.querySelectorAll('input[name="interests"]:checked')
            ).map(checkbox => checkbox.value);
            
            // Map interest values to UUIDs
            const interestIds = [];
            if (window.interestsData) {
                for (const value of selectedInterestValues) {
                    if (window.interestsData[value]) {
                        interestIds.push(window.interestsData[value]);
                    }
                }
            }
            
            // Get form data with debugging
            const nameValue = document.getElementById('name').value;
            const organizationValue = document.getElementById('organization').value.trim() || null;
            
            console.log('DEBUG: Name field value:', nameValue);
            console.log('DEBUG: Organization field value:', organizationValue);
            console.log('DEBUG: Organization field element:', document.getElementById('organization'));
            
            const formData = {
                name: nameValue,
                phone_number: phoneInput.getNumber(), // This includes the country code
                idNumber: document.getElementById('idNumber').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                date_of_birth: document.getElementById('date_of_birth').value,
                gender: document.getElementById('gender').value,
                country: new Intl.DisplayNames(['en'], { type: 'region' }).of(document.getElementById('country').value),
                is_employed: document.getElementById('employment').value === 'true',
                education_level: document.getElementById('education').value,
                pwd_status: document.getElementById('pwd_status').value,
                organization: organizationValue,
                interests: selectedInterestValues,
                interest_ids: interestIds
            };
            
            console.log('DEBUG: Complete formData object:', formData);

            // Validate interests
            if (formData.interests.length === 0) {
                alert('Please select at least one interest.');
                form.dataset.submitting = 'false';
                if (submitBtn) submitBtn.disabled = false;
                return;
            }
            if (formData.interests.length > 3) {
                alert('You can only select up to 3 interests.');
                form.dataset.submitting = 'false';
                if (submitBtn) submitBtn.disabled = false;
                return;
            }

            try {
                // Sign up the user with metadata
                const { data, error } = await signUp(formData);
                
                if (error) {
                    throw error;
                }

                // If signup successful, create profile entry
                if (data?.user) {
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .insert({
                            id: data.user.id,
                            full_name: formData.name,
                            phone_number: formData.phone_number,
                            id_number: formData.idNumber,
                            date_of_birth: formData.date_of_birth,
                            gender: formData.gender,
                            country: formData.country,
                            is_employed: formData.is_employed,
                            education_level: formData.education_level,
                            updated_at: new Date()
                        });

                    if (profileError) {
                        console.error('Error creating profile:', profileError);
                        // Still proceed since auth was successful
                    }
                }

                // If signup successful and we have a confirmation
                if (data) {
                    if (data.session) {
                        // User is automatically signed in - redirect to profile
                        window.location.href = 'profile.html';
                    } else {
                        // Email confirmation may be required - show message
                        showNotification();
                    }
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed: ' + (error.message || 'Unknown error'));
                form.dataset.submitting = 'false';
                if (submitBtn) submitBtn.disabled = false;
            }
            form.dataset.submitting = 'false';
            if (submitBtn) submitBtn.disabled = false;
        });
    });
    </script>

    <style>
        .interests-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
        }
        .interest-option {
            margin-bottom: 10px;
        }
        .interest-option input[type="checkbox"] {
            margin-right: 8px;
        }
        .interest-option label {
            font-weight: normal;
            cursor: pointer;
        }
        /* Phone input styles */
        .iti {
            width: 100% !important;
            position: relative;
        }
        .iti__flag-container {
            display: flex;
            align-items: center;
            background: none !important;
            z-index: 10;
        }
        .iti__selected-flag {
            background: none !important;
        }
        .iti__country-list {
            z-index: 9999 !important;
        }
        .form-group .input-group {
            display: flex;
            align-items: stretch;
        }
        .form-group .input-group input {
            flex: 1;
        }
        /* Fix for flag/country code disappearing */
        .iti .iti__flag {
            display: block !important;
        }
        .iti .iti__selected-dial-code {
            display: inline-block !important;
            color: #333;
            font-weight: 500;
        }
        .iti input.form-control {
            padding-left: 90px !important;
        }
        
        /* Country dropdown styles */
        .countries-dropdown {
            height: auto !important;
        }
        .countries-dropdown option {
            padding: 8px;
            display: flex;
            align-items: center;
        }
        .flag-icon {
            margin-right: 8px;
            border-radius: 2px;
            display: inline-block;
            width: 1.5em;
            height: 1em;
            background-size: cover;
            background-position: center;
            vertical-align: middle;
        }
        /* Style for the selected option */
        .countries-dropdown option:checked {
            background-color: #f0f0f0;
            font-weight: bold;
        }
    </style>

</body>
</html>